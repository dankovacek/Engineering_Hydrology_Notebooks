
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Notebook 4: Event-Based Rainfall-Runoff Modelling &#8212; Engineering Hydrology</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Notebook 5: Extreme Values, Uncertainty, and Risk" href="../Notebook_5/Notebook_5.html" />
    <link rel="prev" title="Notebook 3: Regional Information Transfer" href="../Notebook_3/Notebook_3.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Engineering Hydrology</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Foreword
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Introduction/Data_Import_and_Review.html">
   Example: Data Import, Review, and Workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Introduction/Example_Notebook.html">
   Example: Clausius-Clapeyron Equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../markdown.html">
   Markdown Files
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Flow Measurement
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Notebook_1/Notebook_1.html">
   Notebook 1: Flow Measurement using the Salt Dilution Method
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Rating Curve Development
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Notebook_2/Notebook_2.html">
   Notebook 2: Rating Curve Development
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Regional Information Transfer
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Notebook_3/Notebook_3.html">
   Notebook 3: Regional Information Transfer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Rainfall-Runoff Model
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Notebook 4: Event-Based Rainfall-Runoff Modelling
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Extreme Values, Uncertainty, and Risk
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Notebook_5/Notebook_5.html">
   Notebook 5: Extreme Values, Uncertainty, and Risk
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/dankovacek/Engineering_Hydrology_Notebooks/main?urlpath=tree/content/notebooks/Notebook_4/Notebook_4.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/dankovacek/Engineering_Hydrology_Notebooks"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/dankovacek/Engineering_Hydrology_Notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Notebook_4/Notebook_4.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/notebooks/Notebook_4/Notebook_4.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hydrograph-development-from-lumped-distributed-models">
   Hydrograph development from lumped &amp; distributed models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-setup">
     Problem Setup
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-precipitation-data">
   Import Precipitation Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-the-data">
   Plot the Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-peak-runoff">
   Estimating Peak Runoff
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rational-method">
     Rational Method
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scs-unit-hydrograph-model">
     SCS Unit Hydrograph Model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rainfall-runoff-response-by-the-rational-method">
   Rainfall-Runoff Response by the Rational Method
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-volume-to-volmeteric-flow-units">
   Convert Volume to volmeteric flow units
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-complex-implementation-spatial-data">
   More Complex Implementation: Spatial Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-1-instantiate-a-grid-from-a-dem-raster">
     Step 1: Instantiate a grid from a DEM raster
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-dem">
     Plot the DEM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resolve-flats-in-dem">
     Resolve flats in DEM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-flow-direction-values">
     Specify flow direction values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#delineate-a-catchment">
     Delineate a Catchment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-flow-accumulation">
     Get flow accumulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-distances-to-upstream-cells">
     Calculate distances to upstream cells
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-weighted-travel-distance">
     Calculate weighted travel distance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#develop-rainfall-runoff-model">
   Develop Rainfall-Runoff Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determine-the-peak-unit-runoff">
     Determine the Peak Unit Runoff
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#question-for-reflection">
   Question for Reflection
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Notebook 4: Event-Based Rainfall-Runoff Modelling</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hydrograph-development-from-lumped-distributed-models">
   Hydrograph development from lumped &amp; distributed models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-setup">
     Problem Setup
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-precipitation-data">
   Import Precipitation Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-the-data">
   Plot the Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-peak-runoff">
   Estimating Peak Runoff
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rational-method">
     Rational Method
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scs-unit-hydrograph-model">
     SCS Unit Hydrograph Model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rainfall-runoff-response-by-the-rational-method">
   Rainfall-Runoff Response by the Rational Method
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-volume-to-volmeteric-flow-units">
   Convert Volume to volmeteric flow units
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-complex-implementation-spatial-data">
   More Complex Implementation: Spatial Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-1-instantiate-a-grid-from-a-dem-raster">
     Step 1: Instantiate a grid from a DEM raster
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-dem">
     Plot the DEM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resolve-flats-in-dem">
     Resolve flats in DEM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-flow-direction-values">
     Specify flow direction values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#delineate-a-catchment">
     Delineate a Catchment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-flow-accumulation">
     Get flow accumulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-distances-to-upstream-cells">
     Calculate distances to upstream cells
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-weighted-travel-distance">
     Calculate weighted travel distance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#develop-rainfall-runoff-model">
   Develop Rainfall-Runoff Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#determine-the-peak-unit-runoff">
     Determine the Peak Unit Runoff
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#question-for-reflection">
   Question for Reflection
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="notebook-4-event-based-rainfall-runoff-modelling">
<h1>Notebook 4: Event-Based Rainfall-Runoff Modelling<a class="headerlink" href="#notebook-4-event-based-rainfall-runoff-modelling" title="Permalink to this headline">#</a></h1>
<section id="hydrograph-development-from-lumped-distributed-models">
<h2>Hydrograph development from lumped &amp; distributed models<a class="headerlink" href="#hydrograph-development-from-lumped-distributed-models" title="Permalink to this headline">#</a></h2>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h3>
<p>In this notebook, we look at two ways of estimating a rainfall-runoff response hydrograph from precipitation data.</p>
<p>First, we’ll use the rational method to approximate peak flow in response to a precipitation event, and we’ll relate it to a water level at an example basin outlet.  We’ll then use an open-source geospatial library to make a simple distributed model of the basin from digital elevation data (DEM).  We’ll calculate the flow direction and flow accumulation in order to delineate a basin and define the stream network, and use this to construct an hydrograph from a precipitation event.</p>
<p>Here we will</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import required packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># advanced statistics library</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>

<span class="c1"># SEE COMMENTS ABOUT PYSHEDS LIBRARY IN NEXT CELL</span>
<span class="kn">from</span> <span class="nn">pysheds.grid</span> <span class="kn">import</span> <span class="n">Grid</span>

<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">LinearColorMapper</span><span class="p">,</span> <span class="n">LogTicker</span><span class="p">,</span> <span class="n">ColorBar</span><span class="p">,</span> <span class="n">BasicTickFormatter</span><span class="p">,</span> <span class="n">VBar</span><span class="p">,</span> <span class="n">ColumnDataSource</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="n">output_notebook</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># import required packages</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">math</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pandas&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-setup">
<h3>Problem Setup<a class="headerlink" href="#problem-setup" title="Permalink to this headline">#</a></h3>
<p>Let’s imagine you had a summer job in Whistler working on a project to grade and re-pave the area around Day Lot 4, including installing drainage to capture water from the parking lot and divert it to a storm water collection system instead of draining into FitzSimmons Creek.</p>
<p><img alt="Satellite Image of the Day Lot 4 area in Whistler" src="../../_images/lot4_diagram1.png" /></p>
<p>It’s summer and the project is scheduled to be completed by fall.  For the sake of this exercise, assume the slope of the parking lot area describes a catchment of roughly <strong>1 <span class="math notranslate nohighlight">\(km^2\)</span></strong> and empties through a temporary channel into a catch basin to be treated before flowing into FitzSimmons Creek.  Unfortunately, beyond the outlet (red dot in the diagram above), the channel has to cross the pedestrian trail that follows the river left bank.  Assume the channel is rectangular in shape, and is 2m wide by 0.25m deep with a hydraulic grade slope of 0.5%.  Assume that sheet flow occurs for 100m in any part of the basin, beyond which channelized flow forms, so we have two times to calculate, <span class="math notranslate nohighlight">\(t_{sheet}\)</span> and <span class="math notranslate nohighlight">\(t_{channel}\)</span>:</p>
<ul class="simple">
<li><p><strong>Channel width (w)</strong>: <span class="math notranslate nohighlight">\(2m\)</span></p></li>
<li><p><strong>Channel Depth (h)</strong>: <span class="math notranslate nohighlight">\(0.25m\)</span></p></li>
<li><p><strong>Hydraulic Grade Line Slope (S)</strong>: 0.005 (0.5%)</p></li>
<li><p><strong>Roughness (n)</strong>: 0.017 (rough asphalt)</p></li>
</ul>
<blockquote>
<div><p><strong>Note:</strong> Given the drainage area is only <span class="math notranslate nohighlight">\(1 km^2\)</span>, do you have a sense of what duration of rainfall is appropriate for estimating the peak of the runoff response hydrograph?  <em>i.e. 1h, 6h, 24h, 48h?</em></p>
</div></blockquote>
</section>
</section>
<section id="import-precipitation-data">
<h2>Import Precipitation Data<a class="headerlink" href="#import-precipitation-data" title="Permalink to this headline">#</a></h2>
<p>We can use the application from the <a class="reference external" href="https://data.pacificclimate.org/portal/pcds/map/">Pacific Climate Impacts Consortium</a> (PCIS) to retrieve climate observations in the Whistler area. For this exercise, we will use historical climate data from the Meteorological Service of Canada (MSC) station at Whistler, BC.  Using the <em>Observation Frequency</em> filter provided, there appear to be a few climate stations with hourly precipitation data:</p>
<p><img alt="Location of Environment Canada climate stations at Whistler with hourly data." src="../../_images/pcds_hourly_stn.png" /></p>
<p>We’ll look at one (<em>ID 1048899: Whistler (2014-2022)</em>) as an example.  Well, no we won’t because it turns out this station does not actually have hourly data, nor do any of the others <em>except one</em> (925 - green triangle circled in red).  <strong>You will always be responsible for your own data validation.</strong>  In the PCIS database has hourly data available at only one location in the Whistler area, and it’s from the Ministry of Forests, Lands, and Resource Operations Wildfire Management Branch (FLNRO-WMB) for a brief period in 2005 (ID 925 ZZ REMSATWX1).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import precipitation data</span>
<span class="c1"># note that the ascii file uses the string &#39;None&#39; for NaN </span>
<span class="c1"># and we need to fix this.  </span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../notebook_data/notebook_4_data/925.ascii&#39;</span><span class="p">,</span>
<span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39; None&#39;</span><span class="p">],</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39; time&#39;</span><span class="p">])</span>
<span class="c1"># note that the ascii format imports the column headers with spaces</span>
<span class="c1"># that need to be cleaned up</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-data">
<h2>Plot the Data<a class="headerlink" href="#plot-the-data" title="Permalink to this headline">#</a></h2>
<p>Here we will use the Bokeh data visualization library to plot the precipitation data.   The ability to zoom in and out of different time scales provides a different perspective and helps with data exploration and review.  We don’t have much data in this case, but if we did, holy crow, look out.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasource</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Hourly Precipitation </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1"> -</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;precipitation&#39;</span><span class="p">,</span> 
<span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">datasource</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;Precipitation&#39;</span><span class="p">,</span> 
<span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_left&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Date&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Precipitation [mm]&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;above&#39;</span>
<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">





<div class="bk-root" id="3f761aa6-c91f-400a-b4b1-4cbab22edbf1" data-root-id="2205"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
    
  const docs_json = {"8ddcf619-9a31-45c9-8274-86d47cda32a9":{"defs":[],"roots":{"references":[{"attributes":{"below":[{"id":"2216"}],"center":[{"id":"2219"},{"id":"2223"},{"id":"2266"}],"height":300,"left":[{"id":"2220"}],"renderers":[{"id":"2242"}],"title":{"id":"2206"},"toolbar":{"id":"2231"},"toolbar_location":"above","width":750,"x_range":{"id":"2208"},"x_scale":{"id":"2212"},"y_range":{"id":"2210"},"y_scale":{"id":"2214"}},"id":"2205","subtype":"Figure","type":"Plot"},{"attributes":{"overlay":{"id":"2230"}},"id":"2226","type":"BoxZoomTool"},{"attributes":{"axis":{"id":"2220"},"coordinates":null,"dimension":1,"group":null,"ticker":null},"id":"2223","type":"Grid"},{"attributes":{},"id":"2246","type":"BasicTickFormatter"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"royalblue"},"hatch_alpha":{"value":0.1},"hatch_color":{"value":"royalblue"},"line_alpha":{"value":0.1},"line_color":{"value":"royalblue"},"top":{"field":"precipitation"},"width":{"value":3600000.0},"x":{"field":"time"}},"id":"2240","type":"VBar"},{"attributes":{},"id":"2247","type":"AllLabels"},{"attributes":{},"id":"2249","type":"DatetimeTickFormatter"},{"attributes":{"base":24,"mantissas":[1,2,4,6,8,12],"max_interval":43200000.0,"min_interval":3600000.0,"num_minor_ticks":0},"id":"2256","type":"AdaptiveTicker"},{"attributes":{},"id":"2250","type":"AllLabels"},{"attributes":{"fill_alpha":{"value":0.2},"fill_color":{"value":"royalblue"},"hatch_alpha":{"value":0.2},"hatch_color":{"value":"royalblue"},"line_alpha":{"value":0.2},"line_color":{"value":"royalblue"},"top":{"field":"precipitation"},"width":{"value":3600000.0},"x":{"field":"time"}},"id":"2241","type":"VBar"},{"attributes":{"mantissas":[1,2,5],"max_interval":500.0,"num_minor_ticks":0},"id":"2254","type":"AdaptiveTicker"},{"attributes":{"base":60,"mantissas":[1,2,5,10,15,20,30],"max_interval":1800000.0,"min_interval":1000.0,"num_minor_ticks":0},"id":"2255","type":"AdaptiveTicker"},{"attributes":{"days":[1,4,7,10,13,16,19,22,25,28]},"id":"2258","type":"DaysTicker"},{"attributes":{"days":[1,15]},"id":"2260","type":"DaysTicker"},{"attributes":{"bottom_units":"screen","coordinates":null,"fill_alpha":0.5,"fill_color":"lightgrey","group":null,"left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"2230","type":"BoxAnnotation"},{"attributes":{"coordinates":null,"data_source":{"id":"2204"},"glyph":{"id":"2239"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"2241"},"nonselection_glyph":{"id":"2240"},"view":{"id":"2243"}},"id":"2242","type":"GlyphRenderer"},{"attributes":{},"id":"2228","type":"ResetTool"},{"attributes":{"days":[1,8,15,22]},"id":"2259","type":"DaysTicker"},{"attributes":{},"id":"2221","type":"BasicTicker"},{"attributes":{},"id":"2265","type":"YearsTicker"},{"attributes":{"axis_label":"Precipitation [mm]","coordinates":null,"formatter":{"id":"2246"},"group":null,"major_label_policy":{"id":"2247"},"ticker":{"id":"2221"}},"id":"2220","type":"LinearAxis"},{"attributes":{"data":{"precipitation":{"__ndarray__":"AAAAAAAAAAAAAAAAAAAAAJqZmZmZmck/AAAAAAAAAACamZmZmZnJPwAAAAAAAPA/MzMzMzMz8z+amZmZmZkBQDMzMzMzMwNAmpmZmZmZ+T8AAAAAAAAAQM3MzMzMzARAzczMzMzMBEBmZmZmZmb2PzMzMzMzMwNAMzMzMzMz8z+amZmZmZnpP5qZmZmZmdk/mpmZmZmZ6T8zMzMzMzPjPzMzMzMzM/M/mpmZmZmZ+T+amZmZmZn5PwAAAAAAAABAmpmZmZmZFUBmZmZmZmYGQDMzMzMzM/M/mpmZmZmZ6T8=","dtype":"float64","order":"little","shape":[28]},"relative_humidity":{"__ndarray__":"AAAAAACATkAAAAAAAABRQAAAAAAAAFNAAAAAAADAU0AAAAAAAABUQAAAAAAAAFVAAAAAAAAAVkAAAAAAAABXQAAAAAAAQFdAAAAAAADAV0AAAAAAAABYQAAAAAAAwFdAAAAAAADAV0AAAAAAAABYQAAAAAAAQFhAAAAAAAAAWEAAAAAAAIBYQAAAAAAAgFhAAAAAAACAWEAAAAAAAIBYQAAAAAAAgFhAAAAAAACAWEAAAAAAAEBYQAAAAAAAAFhAAAAAAACAWEAAAAAAAABYQAAAAAAAAFhAAAAAAAAAWEA=","dtype":"float64","order":"little","shape":[28]},"temperature":{"__ndarray__":"MzMzMzMzJ0BmZmZmZmYmQDMzMzMzMyZAAAAAAAAAJUAAAAAAAAAkQM3MzMzMzCFAAAAAAAAAIUBmZmZmZmYgQJqZmZmZmR9AMzMzMzMzH0DNzMzMzMweQJqZmZmZmR9AAAAAAAAAIEAzMzMzMzMgQGZmZmZmZiBAzczMzMzMIEAzMzMzMzMhQDMzMzMzMyFAAAAAAAAAIUAzMzMzMzMhQDMzMzMzMyFAMzMzMzMzIUAAAAAAAAAiQGZmZmZmZiJAZmZmZmZmIkAzMzMzMzMjQDMzMzMzMyRAMzMzMzMzJUA=","dtype":"float64","order":"little","shape":[28]},"time":{"__ndarray__":"AACQycJpcEIAAHg4xmlwQgAAYKfJaXBCAABIFs1pcEIAADCF0GlwQgAAGPTTaXBCAAAAY9dpcEIAAOjR2mlwQgAA0EDeaXBCAAC4r+FpcEIAAKAe5WlwQgAAiI3oaXBCAABw/OtpcEIAAFhr72lwQgAAQNryaXBCAAAoSfZpcEIAABC4+WlwQgAA+Cb9aXBCAADglQBqcEIAAMgEBGpwQgAAsHMHanBCAACY4gpqcEIAAIBRDmpwQgAAaMARanBCAABQLxVqcEIAADieGGpwQgAAIA0canBCAAAIfB9qcEI=","dtype":"float64","order":"little","shape":[28]},"wind_direction":{"__ndarray__":"AAAAAABAbUAAAAAAAKBsQAAAAAAAAGxAAAAAAADgbkAAAAAAAKBuQAAAAAAA4GxAAAAAAABgbEAAAAAAAEBsQAAAAAAAIGxAAAAAAACAZkAAAAAAAOBmQAAAAAAAQGZAAAAAAAAAaUAAAAAAAGBoQAAAAAAAYGpAAAAAAADAakAAAAAAAEBrQAAAAAAAQGdAAAAAAADgaEAAAAAAAIBnQAAAAAAAQGlAAAAAAACgY0AAAAAAAKBjQAAAAAAAIGdAAAAAAADAZUAAAAAAAGBpQAAAAAAAAGtAAAAAAAAAbEA=","dtype":"float64","order":"little","shape":[28]},"wind_speed":{"__ndarray__":"zczMzMzMKUCamZmZmZktQM3MzMzMzCRAmpmZmZmZK0DNzMzMzMwrQDMzMzMzMyhAzczMzMzMIUCamZmZmZkmQJqZmZmZmShAmpmZmZmZHUDNzMzMzMwYQGZmZmZmZh5AZmZmZmZmHEBmZmZmZmYiQM3MzMzMzB5AzczMzMzMIEDNzMzMzMweQAAAAAAAABpAmpmZmZmZIEAzMzMzMzMhQGZmZmZmZh5AAAAAAAAAIEDNzMzMzMwYQJqZmZmZmSZAzczMzMzMDECamZmZmZkiQJqZmZmZmSNAzczMzMzMKUA=","dtype":"float64","order":"little","shape":[28]}},"selected":{"id":"2252"},"selection_policy":{"id":"2251"}},"id":"2204","type":"ColumnDataSource"},{"attributes":{"months":[0,2,4,6,8,10]},"id":"2262","type":"MonthsTicker"},{"attributes":{},"id":"2224","type":"PanTool"},{"attributes":{},"id":"2210","type":"DataRange1d"},{"attributes":{"months":[0,1,2,3,4,5,6,7,8,9,10,11]},"id":"2261","type":"MonthsTicker"},{"attributes":{},"id":"2229","type":"HelpTool"},{"attributes":{"months":[0,6]},"id":"2264","type":"MonthsTicker"},{"attributes":{},"id":"2251","type":"UnionRenderers"},{"attributes":{"source":{"id":"2204"}},"id":"2243","type":"CDSView"},{"attributes":{"coordinates":null,"group":null,"text":"Hourly Precipitation 2005-09-28 -2005-09-29"},"id":"2206","type":"Title"},{"attributes":{},"id":"2225","type":"WheelZoomTool"},{"attributes":{"months":[0,4,8]},"id":"2263","type":"MonthsTicker"},{"attributes":{},"id":"2208","type":"DataRange1d"},{"attributes":{},"id":"2227","type":"SaveTool"},{"attributes":{"num_minor_ticks":5,"tickers":[{"id":"2254"},{"id":"2255"},{"id":"2256"},{"id":"2257"},{"id":"2258"},{"id":"2259"},{"id":"2260"},{"id":"2261"},{"id":"2262"},{"id":"2263"},{"id":"2264"},{"id":"2265"}]},"id":"2217","type":"DatetimeTicker"},{"attributes":{},"id":"2252","type":"Selection"},{"attributes":{},"id":"2212","type":"LinearScale"},{"attributes":{"fill_color":{"value":"royalblue"},"hatch_color":{"value":"royalblue"},"line_color":{"value":"royalblue"},"top":{"field":"precipitation"},"width":{"value":3600000.0},"x":{"field":"time"}},"id":"2239","type":"VBar"},{"attributes":{"axis_label":"Date","coordinates":null,"formatter":{"id":"2249"},"group":null,"major_label_policy":{"id":"2250"},"ticker":{"id":"2217"}},"id":"2216","type":"DatetimeAxis"},{"attributes":{"tools":[{"id":"2224"},{"id":"2225"},{"id":"2226"},{"id":"2227"},{"id":"2228"},{"id":"2229"}]},"id":"2231","type":"Toolbar"},{"attributes":{"coordinates":null,"group":null,"items":[{"id":"2267"}],"location":"top_left"},"id":"2266","type":"Legend"},{"attributes":{"label":{"value":"Precipitation"},"renderers":[{"id":"2242"}]},"id":"2267","type":"LegendItem"},{"attributes":{"axis":{"id":"2216"},"coordinates":null,"group":null,"ticker":null},"id":"2219","type":"Grid"},{"attributes":{},"id":"2214","type":"LinearScale"},{"attributes":{"days":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]},"id":"2257","type":"DaysTicker"}],"root_ids":["2205"]},"title":"Bokeh Application","version":"2.4.2"}};
  const render_items = [{"docid":"8ddcf619-9a31-45c9-8274-86d47cda32a9","root_ids":["2205"],"roots":{"2205":"3f761aa6-c91f-400a-b4b1-4cbab22edbf1"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);

  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
</section>
<section id="estimating-peak-runoff">
<h2>Estimating Peak Runoff<a class="headerlink" href="#estimating-peak-runoff" title="Permalink to this headline">#</a></h2>
<p>It is rare to find long-term records at a high frequency of measurement, so <strong>we do the best we can with the information available</strong>.  Below, we’ll look at a few ways of constructing a hydrograph.  We want to construct a hydrograph because if we can accurately predict its peak (or more generally its shape), we can design hydraulic structures and other water management systems.  We’ll start with a very basic estimate that has minimal information requirements, and move to more complex and information-intensive methods.</p>
<p>In the problem setup we asked <em>“will the outlet channel be big enough”</em>.  Water resources problems are often expressed in terms of risk, and typically for this kind of analysis we communicate risk in terms of annual exceedance probability (AEP).  In other words, what is the probability that the flow in the channel will exceed its capacity in a given year?  <strong>These kinds of problems do not have a right answer, they are open-ended and subjective—meaning there is always some judgment that needs to be applied.</strong>  The topic of risk will be discussed further in Notebook 5.  For now, we want to focus on a few ways of estimating (the peak of) a runoff hydrograph from precipitation data.</p>
<section id="rational-method">
<h3>Rational Method<a class="headerlink" href="#rational-method" title="Permalink to this headline">#</a></h3>
<p>Recall that the peak runoff for a small basin can be estimated by <a class="reference external" href="https://www.tad.usace.army.mil/Portals/53/docs/TAA/AEDDesignRequirements/AED%20Design%20Requirements-%20Hydrology%20Studies_Feb-11.pdf">the following</a> from the US Army Corps of Engineers (USACE):</p>
<div class="math notranslate nohighlight">
\[Q = k\cdot C\cdot I \cdot a\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><strong>k</strong>: 0.278 [-]</p></li>
<li><p><strong>C</strong>: runoff coefficient [-]</p></li>
<li><p><strong>I</strong>: rainfall intensity [mm/hr]</p></li>
<li><p><strong>a</strong>: drainage area [<span class="math notranslate nohighlight">\(km^2\)</span>]</p></li>
</ul>
<p>We have already estimated drainage area, and there are just two additional pieces of information we need to estimate the peak runoff for our basin.  The runoff coefficient “C” can be found in a table of empirical values in the USACE link above, and the rainfall intensity can be estimated from <a class="reference external" href="https://climate.weather.gc.ca/prods_servs/engineering_e.html">Intensity-Duration-Frequency</a> curve data developed by Environment Canada.  <a class="reference external" href="https://climatedata.ca/resource/best-practices-for-using-idf-curves/">More information on IDF Curve usage</a>.  We can find IDF curves for specific locations using the <a class="reference external" href="https://climatedata.ca/download/#idf-download">web application at climatedata.ca</a>.  The IDF curve for Whistler is below:</p>
<p><img alt="IDF Curve for Whistler, BC." src="../../_images/IDF.png" /></p>
<p>We don’t really know the appropriate duration yet for our basin, but we can select a few and run calculations to see how sensitive this model is to the duration.  The five diagonal lines represent different return periods (2, 5, 10, 20, 50, 100).  The return period is the inverse of the AEP, and again it represents the probability of occurrence <strong>in any given year</strong>, and it does not suggest an event of any magnitude will occur once in that return period.</p>
<p>Below we’ll use a range of the values that we’re not too sure about their effect on the estimated hydrograph (peak flow).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rational_method_peak_flow</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate peak flow (m^3/s) using the rational method.</span>

<span class="sd">    Args:</span>
<span class="sd">        C (float): runoff coefficient</span>
<span class="sd">        I (float): rainfall intensity [mm/hr]</span>
<span class="sd">        a (float): drainage area [km^2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.278</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we&#39;ll define an array of three runoff coefficient values </span>
<span class="c1"># to get a sense of the range of possible conditions</span>
<span class="c1"># minimum, maximum, and expected value</span>
<span class="n">C_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>

<span class="c1"># for each return period, we&#39;ll read the minimum and maximum intensity</span>
<span class="c1"># and use these to see the range of outcomes</span>
<span class="n">IDF_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span> <span class="c1"># the 2 and 100 year intensities are 22mm, 45mm (5 min)</span>
    <span class="mi">15</span><span class="p">:</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
    <span class="mi">60</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="mi">1440</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># 1440 minutes is 24 hours</span>
<span class="p">}</span>
        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the range of flow estimates for each C and each return period</span>
<span class="c1"># and create a plot for each runoff coefficient</span>
<span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rational_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C_values</span><span class="p">:</span>   
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Rational Method C=</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> 
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">i_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">)</span> <span class="ow">in</span> <span class="n">IDF_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>      
        <span class="n">Q_min</span> <span class="o">=</span> <span class="n">rational_method_peak_flow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_max</span> <span class="o">=</span> <span class="n">rational_method_peak_flow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_min</span><span class="p">,</span> <span class="n">i_max</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Q_min</span><span class="p">,</span> <span class="n">Q_max</span><span class="p">]</span>
        <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">min&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Flow [m^3/s]&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Return Period&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.layouts</span> <span class="kn">import</span> <span class="n">gridplot</span>
<span class="n">layout</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">





<div class="bk-root" id="28294cc3-3c24-4d17-9c2c-7c2ea88a376a" data-root-id="5204"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
    
  const docs_json = {"9c77d9e8-223b-4c5c-b5a2-f73d92699cf9":{"defs":[],"roots":{"references":[{"attributes":{"children":[{"id":"5203"},{"id":"5201"}]},"id":"5204","type":"Column"},{"attributes":{"axis_label":"Return Period","coordinates":null,"formatter":{"id":"5080"},"group":null,"major_label_policy":{"id":"5081"},"ticker":{"id":"5048"}},"id":"5047","type":"LinearAxis"},{"attributes":{},"id":"4969","type":"Selection"},{"attributes":{},"id":"5033","type":"Selection"},{"attributes":{},"id":"5043","type":"LinearScale"},{"attributes":{"coordinates":null,"group":null,"text":"Rational Method C=0.7"},"id":"5037","type":"Title"},{"attributes":{},"id":"5077","type":"BasicTickFormatter"},{"attributes":{"coordinates":null,"group":null,"items":[{"id":"5086"},{"id":"5105"},{"id":"5126"},{"id":"5149"}]},"id":"5085","type":"Legend"},{"attributes":{},"id":"5041","type":"DataRange1d"},{"attributes":{"line_alpha":0.2,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4995","type":"Line"},{"attributes":{},"id":"5078","type":"AllLabels"},{"attributes":{},"id":"5048","type":"BasicTicker"},{"attributes":{"axis":{"id":"5047"},"coordinates":null,"group":null,"ticker":null},"id":"5050","type":"Grid"},{"attributes":{},"id":"5045","type":"LinearScale"},{"attributes":{"axis_label":"Flow [m^3/s]","coordinates":null,"formatter":{"id":"5077"},"group":null,"major_label_policy":{"id":"5078"},"ticker":{"id":"5052"}},"id":"5051","type":"LinearAxis"},{"attributes":{},"id":"5080","type":"BasicTickFormatter"},{"attributes":{},"id":"5060","type":"HelpTool"},{"attributes":{"data":{"x":[7,15],"y":[1.7514000000000003,3.7530000000000006]},"selected":{"id":"5010"},"selection_policy":{"id":"5009"}},"id":"4992","type":"ColumnDataSource"},{"attributes":{},"id":"5081","type":"AllLabels"},{"attributes":{},"id":"4968","type":"UnionRenderers"},{"attributes":{"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4993","type":"Line"},{"attributes":{"axis":{"id":"5051"},"coordinates":null,"dimension":1,"group":null,"ticker":null},"id":"5054","type":"Grid"},{"attributes":{"source":{"id":"4992"}},"id":"4997","type":"CDSView"},{"attributes":{"line_alpha":0.1,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4994","type":"Line"},{"attributes":{},"id":"5052","type":"BasicTicker"},{"attributes":{"line_alpha":0.2,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5072","type":"Line"},{"attributes":{},"id":"5056","type":"WheelZoomTool"},{"attributes":{"label":{"value":"5min"},"renderers":[{"id":"4959"}]},"id":"4972","type":"LegendItem"},{"attributes":{},"id":"5055","type":"PanTool"},{"attributes":{"label":{"value":"60min"},"renderers":[{"id":"4996"}]},"id":"5012","type":"LegendItem"},{"attributes":{"overlay":{"id":"5061"}},"id":"5057","type":"BoxZoomTool"},{"attributes":{},"id":"5058","type":"SaveTool"},{"attributes":{},"id":"5059","type":"ResetTool"},{"attributes":{},"id":"5082","type":"UnionRenderers"},{"attributes":{"line_alpha":0.2,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4958","type":"Line"},{"attributes":{"bottom_units":"screen","coordinates":null,"fill_alpha":0.5,"fill_color":"lightgrey","group":null,"left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"5061","type":"BoxAnnotation"},{"attributes":{},"id":"5083","type":"Selection"},{"attributes":{"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4956","type":"Line"},{"attributes":{"label":{"value":"5min"},"renderers":[{"id":"5073"}]},"id":"5086","type":"LegendItem"},{"attributes":{"line_alpha":0.2,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4862","type":"Line"},{"attributes":{"coordinates":null,"data_source":{"id":"4859"},"glyph":{"id":"4860"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4862"},"nonselection_glyph":{"id":"4861"},"view":{"id":"4864"}},"id":"4863","type":"GlyphRenderer"},{"attributes":{"coordinates":null,"group":null,"items":[{"id":"4972"},{"id":"4991"},{"id":"5012"},{"id":"5035"}]},"id":"4971","type":"Legend"},{"attributes":{"data":{"x":[14,28],"y":[1.9460000000000002,3.8920000000000003]},"selected":{"id":"4875"},"selection_policy":{"id":"4874"}},"id":"4859","type":"ColumnDataSource"},{"attributes":{"source":{"id":"4955"}},"id":"4960","type":"CDSView"},{"attributes":{"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4860","type":"Line"},{"attributes":{"source":{"id":"4859"}},"id":"4864","type":"CDSView"},{"attributes":{"line_alpha":0.1,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4957","type":"Line"},{"attributes":{"line_alpha":0.1,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4861","type":"Line"},{"attributes":{"coordinates":null,"data_source":{"id":"4899"},"glyph":{"id":"4900"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4902"},"nonselection_glyph":{"id":"4901"},"view":{"id":"4904"}},"id":"4903","type":"GlyphRenderer"},{"attributes":{"label":{"value":"15min"},"renderers":[{"id":"4863"}]},"id":"4877","type":"LegendItem"},{"attributes":{"line_alpha":0.2,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"5016","type":"Line"},{"attributes":{},"id":"5010","type":"Selection"},{"attributes":{},"id":"4874","type":"UnionRenderers"},{"attributes":{"coordinates":null,"data_source":{"id":"5013"},"glyph":{"id":"5014"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"5016"},"nonselection_glyph":{"id":"5015"},"view":{"id":"5018"}},"id":"5017","type":"GlyphRenderer"},{"attributes":{"coordinates":null,"data_source":{"id":"4992"},"glyph":{"id":"4993"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4995"},"nonselection_glyph":{"id":"4994"},"view":{"id":"4997"}},"id":"4996","type":"GlyphRenderer"},{"attributes":{"line_alpha":0.1,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5071","type":"Line"},{"attributes":{},"id":"4875","type":"Selection"},{"attributes":{},"id":"5039","type":"DataRange1d"},{"attributes":{"line_alpha":0.2,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4976","type":"Line"},{"attributes":{"coordinates":null,"data_source":{"id":"4973"},"glyph":{"id":"4974"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4976"},"nonselection_glyph":{"id":"4975"},"view":{"id":"4978"}},"id":"4977","type":"GlyphRenderer"},{"attributes":{"data":{"x":[2,4],"y":[0.5004000000000001,1.0008000000000001]},"selected":{"id":"5033"},"selection_policy":{"id":"5032"}},"id":"5013","type":"ColumnDataSource"},{"attributes":{"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"5014","type":"Line"},{"attributes":{"data":{"x":[14,28],"y":[3.5028000000000006,7.005600000000001]},"selected":{"id":"4989"},"selection_policy":{"id":"4988"}},"id":"4973","type":"ColumnDataSource"},{"attributes":{"source":{"id":"5013"}},"id":"5018","type":"CDSView"},{"attributes":{"line_alpha":0.1,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"5015","type":"Line"},{"attributes":{"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4974","type":"Line"},{"attributes":{"source":{"id":"4973"}},"id":"4978","type":"CDSView"},{"attributes":{"line_alpha":0.1,"line_color":"yellow","x":{"field":"x"},"y":{"field":"y"}},"id":"4975","type":"Line"},{"attributes":{"source":{"id":"5069"}},"id":"5074","type":"CDSView"},{"attributes":{"label":{"value":"1440min"},"renderers":[{"id":"5017"}]},"id":"5035","type":"LegendItem"},{"attributes":{"tools":[{"id":"5055"},{"id":"5056"},{"id":"5057"},{"id":"5058"},{"id":"5059"},{"id":"5060"}]},"id":"5062","type":"Toolbar"},{"attributes":{"label":{"value":"15min"},"renderers":[{"id":"4977"}]},"id":"4991","type":"LegendItem"},{"attributes":{},"id":"4988","type":"UnionRenderers"},{"attributes":{"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5070","type":"Line"},{"attributes":{},"id":"4989","type":"Selection"},{"attributes":{"coordinates":null,"data_source":{"id":"5106"},"glyph":{"id":"5107"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"5109"},"nonselection_glyph":{"id":"5108"},"view":{"id":"5111"}},"id":"5110","type":"GlyphRenderer"},{"attributes":{"line_alpha":0.2,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5090","type":"Line"},{"attributes":{"coordinates":null,"data_source":{"id":"5087"},"glyph":{"id":"5088"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"5090"},"nonselection_glyph":{"id":"5089"},"view":{"id":"5092"}},"id":"5091","type":"GlyphRenderer"},{"attributes":{"line_alpha":0.2,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4881","type":"Line"},{"attributes":{"data":{"x":[14,28],"y":[2.7244,5.4488]},"selected":{"id":"5103"},"selection_policy":{"id":"5102"}},"id":"5087","type":"ColumnDataSource"},{"attributes":{},"id":"4963","type":"BasicTickFormatter"},{"attributes":{"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5088","type":"Line"},{"attributes":{"source":{"id":"5087"}},"id":"5092","type":"CDSView"},{"attributes":{"coordinates":null,"data_source":{"id":"4878"},"glyph":{"id":"4879"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4881"},"nonselection_glyph":{"id":"4880"},"view":{"id":"4883"}},"id":"4882","type":"GlyphRenderer"},{"attributes":{"line_alpha":0.1,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5089","type":"Line"},{"attributes":{},"id":"4964","type":"AllLabels"},{"attributes":{"source":{"id":"4878"}},"id":"4883","type":"CDSView"},{"attributes":{"data":{"x":[7,15],"y":[0.9730000000000001,2.085]},"selected":{"id":"4896"},"selection_policy":{"id":"4895"}},"id":"4878","type":"ColumnDataSource"},{"attributes":{"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4879","type":"Line"},{"attributes":{},"id":"4966","type":"BasicTickFormatter"},{"attributes":{"label":{"value":"15min"},"renderers":[{"id":"5091"}]},"id":"5105","type":"LegendItem"},{"attributes":{},"id":"5102","type":"UnionRenderers"},{"attributes":{"line_alpha":0.1,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4880","type":"Line"},{"attributes":{},"id":"4967","type":"AllLabels"},{"attributes":{"label":{"value":"60min"},"renderers":[{"id":"4882"}]},"id":"4898","type":"LegendItem"},{"attributes":{},"id":"5103","type":"Selection"},{"attributes":{"line_alpha":0.2,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4844","type":"Line"},{"attributes":{},"id":"4895","type":"UnionRenderers"},{"attributes":{"coordinates":null,"data_source":{"id":"5069"},"glyph":{"id":"5070"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"5072"},"nonselection_glyph":{"id":"5071"},"view":{"id":"5074"}},"id":"5073","type":"GlyphRenderer"},{"attributes":{"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4842","type":"Line"},{"attributes":{"line_alpha":0.1,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4843","type":"Line"},{"attributes":{"data":{"x":[22,45],"y":[4.2812,8.757]},"selected":{"id":"5083"},"selection_policy":{"id":"5082"}},"id":"5069","type":"ColumnDataSource"},{"attributes":{"toolbar":{"id":"5202"},"toolbar_location":"above"},"id":"5203","type":"ToolbarBox"},{"attributes":{"source":{"id":"4841"}},"id":"4846","type":"CDSView"},{"attributes":{"coordinates":null,"group":null,"items":[{"id":"4858"},{"id":"4877"},{"id":"4898"},{"id":"4921"}]},"id":"4857","type":"Legend"},{"attributes":{"label":{"value":"5min"},"renderers":[{"id":"4845"}]},"id":"4858","type":"LegendItem"},{"attributes":{"line_alpha":0.2,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4902","type":"Line"},{"attributes":{},"id":"4927","type":"DataRange1d"},{"attributes":{"line_alpha":0.2,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5109","type":"Line"},{"attributes":{"data":{"x":[2,4],"y":[0.278,0.556]},"selected":{"id":"4919"},"selection_policy":{"id":"4918"}},"id":"4899","type":"ColumnDataSource"},{"attributes":{"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4900","type":"Line"},{"attributes":{"source":{"id":"4899"}},"id":"4904","type":"CDSView"},{"attributes":{},"id":"5123","type":"UnionRenderers"},{"attributes":{},"id":"4813","type":"DataRange1d"},{"attributes":{"line_alpha":0.1,"line_color":"green","x":{"field":"x"},"y":{"field":"y"}},"id":"4901","type":"Line"},{"attributes":{"axis_label":"Return Period","coordinates":null,"formatter":{"id":"4966"},"group":null,"major_label_policy":{"id":"4967"},"ticker":{"id":"4934"}},"id":"4933","type":"LinearAxis"},{"attributes":{"coordinates":null,"data_source":{"id":"4841"},"glyph":{"id":"4842"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4844"},"nonselection_glyph":{"id":"4843"},"view":{"id":"4846"}},"id":"4845","type":"GlyphRenderer"},{"attributes":{"data":{"x":[7,15],"y":[1.3622,2.919]},"selected":{"id":"5124"},"selection_policy":{"id":"5123"}},"id":"5106","type":"ColumnDataSource"},{"attributes":{"below":[{"id":"4819"}],"center":[{"id":"4822"},{"id":"4826"},{"id":"4857"}],"height":400,"left":[{"id":"4823"}],"renderers":[{"id":"4845"},{"id":"4863"},{"id":"4882"},{"id":"4903"}],"title":{"id":"4809"},"toolbar":{"id":"4834"},"toolbar_location":null,"width":250,"x_range":{"id":"4811"},"x_scale":{"id":"4815"},"y_range":{"id":"4813"},"y_scale":{"id":"4817"}},"id":"4808","subtype":"Figure","type":"Plot"},{"attributes":{"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5107","type":"Line"},{"attributes":{"label":{"value":"1440min"},"renderers":[{"id":"4903"}]},"id":"4921","type":"LegendItem"},{"attributes":{"source":{"id":"5106"}},"id":"5111","type":"CDSView"},{"attributes":{},"id":"4811","type":"DataRange1d"},{"attributes":{"line_alpha":0.1,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5108","type":"Line"},{"attributes":{"below":[{"id":"4933"}],"center":[{"id":"4936"},{"id":"4940"},{"id":"4971"}],"height":400,"left":[{"id":"4937"}],"renderers":[{"id":"4959"},{"id":"4977"},{"id":"4996"},{"id":"5017"}],"title":{"id":"4923"},"toolbar":{"id":"4948"},"toolbar_location":null,"width":250,"x_range":{"id":"4925"},"x_scale":{"id":"4929"},"y_range":{"id":"4927"},"y_scale":{"id":"4931"}},"id":"4922","subtype":"Figure","type":"Plot"},{"attributes":{},"id":"5147","type":"Selection"},{"attributes":{},"id":"4815","type":"LinearScale"},{"attributes":{"coordinates":null,"group":null,"text":"Rational Method C=0.5"},"id":"4809","type":"Title"},{"attributes":{"axis_label":"Return Period","coordinates":null,"formatter":{"id":"4852"},"group":null,"major_label_policy":{"id":"4853"},"ticker":{"id":"4820"}},"id":"4819","type":"LinearAxis"},{"attributes":{"label":{"value":"60min"},"renderers":[{"id":"5110"}]},"id":"5126","type":"LegendItem"},{"attributes":{},"id":"4820","type":"BasicTicker"},{"attributes":{"axis":{"id":"4819"},"coordinates":null,"group":null,"ticker":null},"id":"4822","type":"Grid"},{"attributes":{},"id":"5124","type":"Selection"},{"attributes":{},"id":"4817","type":"LinearScale"},{"attributes":{"axis_label":"Flow [m^3/s]","coordinates":null,"formatter":{"id":"4849"},"group":null,"major_label_policy":{"id":"4850"},"ticker":{"id":"4824"}},"id":"4823","type":"LinearAxis"},{"attributes":{},"id":"4832","type":"HelpTool"},{"attributes":{},"id":"4849","type":"BasicTickFormatter"},{"attributes":{"axis":{"id":"4823"},"coordinates":null,"dimension":1,"group":null,"ticker":null},"id":"4826","type":"Grid"},{"attributes":{},"id":"4850","type":"AllLabels"},{"attributes":{},"id":"4824","type":"BasicTicker"},{"attributes":{"data":{"x":[22,45],"y":[3.0580000000000003,6.255000000000001]},"selected":{"id":"4855"},"selection_policy":{"id":"4854"}},"id":"4841","type":"ColumnDataSource"},{"attributes":{},"id":"4919","type":"Selection"},{"attributes":{},"id":"4852","type":"BasicTickFormatter"},{"attributes":{},"id":"4828","type":"WheelZoomTool"},{"attributes":{},"id":"4827","type":"PanTool"},{"attributes":{"overlay":{"id":"4833"}},"id":"4829","type":"BoxZoomTool"},{"attributes":{},"id":"4853","type":"AllLabels"},{"attributes":{},"id":"4830","type":"SaveTool"},{"attributes":{},"id":"4831","type":"ResetTool"},{"attributes":{},"id":"5032","type":"UnionRenderers"},{"attributes":{"coordinates":null,"group":null,"text":"Rational Method C=0.9"},"id":"4923","type":"Title"},{"attributes":{"bottom_units":"screen","coordinates":null,"fill_alpha":0.5,"fill_color":"lightgrey","group":null,"left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"4833","type":"BoxAnnotation"},{"attributes":{},"id":"4918","type":"UnionRenderers"},{"attributes":{},"id":"5009","type":"UnionRenderers"},{"attributes":{"below":[{"id":"5047"}],"center":[{"id":"5050"},{"id":"5054"},{"id":"5085"}],"height":400,"left":[{"id":"5051"}],"renderers":[{"id":"5073"},{"id":"5091"},{"id":"5110"},{"id":"5131"}],"title":{"id":"5037"},"toolbar":{"id":"5062"},"toolbar_location":null,"width":250,"x_range":{"id":"5039"},"x_scale":{"id":"5043"},"y_range":{"id":"5041"},"y_scale":{"id":"5045"}},"id":"5036","subtype":"Figure","type":"Plot"},{"attributes":{},"id":"4929","type":"LinearScale"},{"attributes":{},"id":"4925","type":"DataRange1d"},{"attributes":{"line_alpha":0.2,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5130","type":"Line"},{"attributes":{"coordinates":null,"data_source":{"id":"4955"},"glyph":{"id":"4956"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"4958"},"nonselection_glyph":{"id":"4957"},"view":{"id":"4960"}},"id":"4959","type":"GlyphRenderer"},{"attributes":{},"id":"4934","type":"BasicTicker"},{"attributes":{"axis":{"id":"4933"},"coordinates":null,"group":null,"ticker":null},"id":"4936","type":"Grid"},{"attributes":{},"id":"4931","type":"LinearScale"},{"attributes":{"coordinates":null,"data_source":{"id":"5127"},"glyph":{"id":"5128"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"5130"},"nonselection_glyph":{"id":"5129"},"view":{"id":"5132"}},"id":"5131","type":"GlyphRenderer"},{"attributes":{},"id":"4854","type":"UnionRenderers"},{"attributes":{"axis_label":"Flow [m^3/s]","coordinates":null,"formatter":{"id":"4963"},"group":null,"major_label_policy":{"id":"4964"},"ticker":{"id":"4938"}},"id":"4937","type":"LinearAxis"},{"attributes":{},"id":"4946","type":"HelpTool"},{"attributes":{"data":{"x":[2,4],"y":[0.3892,0.7784]},"selected":{"id":"5147"},"selection_policy":{"id":"5146"}},"id":"5127","type":"ColumnDataSource"},{"attributes":{"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5128","type":"Line"},{"attributes":{},"id":"4855","type":"Selection"},{"attributes":{},"id":"4896","type":"Selection"},{"attributes":{"source":{"id":"5127"}},"id":"5132","type":"CDSView"},{"attributes":{"axis":{"id":"4937"},"coordinates":null,"dimension":1,"group":null,"ticker":null},"id":"4940","type":"Grid"},{"attributes":{"line_alpha":0.1,"line_color":"red","x":{"field":"x"},"y":{"field":"y"}},"id":"5129","type":"Line"},{"attributes":{},"id":"4938","type":"BasicTicker"},{"attributes":{"data":{"x":[22,45],"y":[5.5044,11.259000000000002]},"selected":{"id":"4969"},"selection_policy":{"id":"4968"}},"id":"4955","type":"ColumnDataSource"},{"attributes":{"bottom_units":"screen","coordinates":null,"fill_alpha":0.5,"fill_color":"lightgrey","group":null,"left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"4947","type":"BoxAnnotation"},{"attributes":{},"id":"4942","type":"WheelZoomTool"},{"attributes":{"label":{"value":"1440min"},"renderers":[{"id":"5131"}]},"id":"5149","type":"LegendItem"},{"attributes":{},"id":"4941","type":"PanTool"},{"attributes":{"toolbars":[{"id":"4834"},{"id":"4948"},{"id":"5062"}],"tools":[{"id":"4827"},{"id":"4828"},{"id":"4829"},{"id":"4830"},{"id":"4831"},{"id":"4832"},{"id":"4941"},{"id":"4942"},{"id":"4943"},{"id":"4944"},{"id":"4945"},{"id":"4946"},{"id":"5055"},{"id":"5056"},{"id":"5057"},{"id":"5058"},{"id":"5059"},{"id":"5060"}]},"id":"5202","type":"ProxyToolbar"},{"attributes":{"overlay":{"id":"4947"}},"id":"4943","type":"BoxZoomTool"},{"attributes":{"tools":[{"id":"4827"},{"id":"4828"},{"id":"4829"},{"id":"4830"},{"id":"4831"},{"id":"4832"}]},"id":"4834","type":"Toolbar"},{"attributes":{},"id":"4944","type":"SaveTool"},{"attributes":{},"id":"5146","type":"UnionRenderers"},{"attributes":{},"id":"4945","type":"ResetTool"},{"attributes":{"children":[[{"id":"4808"},0,0],[{"id":"4922"},0,1],[{"id":"5036"},1,0]]},"id":"5201","type":"GridBox"},{"attributes":{"tools":[{"id":"4941"},{"id":"4942"},{"id":"4943"},{"id":"4944"},{"id":"4945"},{"id":"4946"}]},"id":"4948","type":"Toolbar"}],"root_ids":["5204"]},"title":"Bokeh Application","version":"2.4.2"}};
  const render_items = [{"docid":"9c77d9e8-223b-4c5c-b5a2-f73d92699cf9","root_ids":["5204"],"roots":{"5204":"28294cc3-3c24-4d17-9c2c-7c2ea88a376a"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);

  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
</section>
<section id="scs-unit-hydrograph-model">
<h3>SCS Unit Hydrograph Model<a class="headerlink" href="#scs-unit-hydrograph-model" title="Permalink to this headline">#</a></h3>
<p>Using the <a class="reference external" href="https://www.hec.usace.army.mil/confluence/hmsdocs/hmstrm/surface-runoff/scs-unit-hydrograph-model">Soil Conservation Service unit hydrograph model</a>, estimate the time of concentration, or the time it takes a drop of rain to flow from any point in the basin to the outlet assuming the area is a plane surface with homogeneous slope and roughness:</p>
<div class="math notranslate nohighlight">
\[t = 6.94 \frac{(L*n)^{0.6}}{I^{0.4}S^{0.3}}\]</div>
<div class="math notranslate nohighlight">
\[t_{sheet} = \frac{0.007(NL)^{0.8}}{P_2^{0.5}S^{0.4}}\]</div>
<p>Where:</p>
<p>Is this a reasonable assumption in general?  <strong>Consider what effect this assumption has on the resulting peak flow.</strong></p>
<p>Lets reconstruct a runoff hydrograph at the outlet given the above information.  First, we import some precipitation data from Whistler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mf">0.0011</span>
<span class="n">S</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">t_sheet</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="rainfall-runoff-response-by-the-rational-method">
<h2>Rainfall-Runoff Response by the Rational Method<a class="headerlink" href="#rainfall-runoff-response-by-the-rational-method" title="Permalink to this headline">#</a></h2>
<p>Below, we find a single precipitation event to use as an example for estimating a runoff hydrograph.  Below we plot a two week period where</p>
</section>
<section id="convert-volume-to-volmeteric-flow-units">
<h2>Convert Volume to volmeteric flow units<a class="headerlink" href="#convert-volume-to-volmeteric-flow-units" title="Permalink to this headline">#</a></h2>
<p>Runoff is typically measured in <span class="math notranslate nohighlight">\(\frac{m^3}{s}\)</span>, so convert <span class="math notranslate nohighlight">\(\frac{mm}{day}\)</span> precipitation to <span class="math notranslate nohighlight">\(\frac{m^3}{s}\)</span> runoff.</p>
<div class="math notranslate nohighlight">
\[1 \frac{mm}{day} \times \frac{1 m}{1000 mm} \times \frac{1 day}{24 h} \times \frac{1 h}{ 3600 s} \times 1 km^2 \times \frac{1000 m \times 1000 m}{1 km^2}= \frac{1}{86.4} \frac{m^3}{s}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert to runoff volume</span>
<span class="n">drainage_area</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># km^2</span>

<span class="c1"># runoff is typically measured in m^3/s (cms for short -- cubic metres per second), </span>
<span class="c1"># so express the runoff in cms</span>
<span class="n">event_df</span><span class="p">[</span><span class="s1">&#39;runoff_cms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_df</span><span class="p">[</span><span class="s1">&#39;Total Rain (mm)&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">86.4</span>
</pre></div>
</div>
</div>
</div>
<p>If the channel outlet has a rectangular shape of width 2m, how tall should our boots be?  Assume a 0.5% slope, and find a reasonable assumption for the roughness of asphalt.</p>
<p>Recall the Manning equation:</p>
<div class="math notranslate nohighlight">
\[Q = \frac{1}{n} A R^{2/3} S^{1/2}\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><strong>n</strong> is the manning roughness</p></li>
<li><p><strong>A</strong> is cross sectional area of the flow</p></li>
<li><p><strong>R</strong> hydraulic radius (area / wetted perimeter)</p></li>
<li><p><strong>S</strong> is the channel slope</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># specify our given information</span>
<span class="n">w_channel</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># m</span>
<span class="n">S</span> <span class="o">=</span> <span class="mf">0.005</span> <span class="c1"># channel slope</span>
<span class="n">n_factor</span> <span class="o">=</span> <span class="mf">0.017</span>  <span class="c1"># rough asphalt</span>

<span class="k">def</span> <span class="nf">calc_Q</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate flow from the Manning equation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">w</span> <span class="c1"># flow area as (depth x width)</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span>  <span class="c1"># wetted perimeter</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">wp</span> <span class="c1"># hydraulic radius (area / wetted perimeter)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">solve_depth</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a flow, a roughness factor, a channel slope, and a channel width, </span>
<span class="sd">    calculate flow depth. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># solve within 1%</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Q_est</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Q_est</span> <span class="o">-</span> <span class="n">Q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">Q_est</span> <span class="o">=</span> <span class="n">calc_Q</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">)</span>
<span class="c1">#         print(Q, Q_est, abs(Q_est - Q))</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="mf">0.001</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1">#     print(&#39;solved in {} iterations&#39;.format(n))</span>
    <span class="k">return</span> <span class="n">d</span> 
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For each timestep, we want to solve for the depth of water at our outlet</span>
<span class="n">event_df</span><span class="p">[</span><span class="s1">&#39;flow_depth_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_df</span><span class="p">[</span><span class="s1">&#39;runoff_cms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">solve_depth</span><span class="p">(</span><span class="n">w_channel</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">event_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">event_df</span><span class="p">[</span><span class="s1">&#39;flow_depth_m&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flow depth [m]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p><strong>Not only are our feet wet, but if we happen to be there the peak it’s potentially dangerous.  As little as 10-15cm of water quickly enough can sweep you off your feet.</strong></p>
</div></blockquote>
<p><img alt="Recalculating Life" src="../../_images/recalculating.png" /></p>
</section>
<section id="more-complex-implementation-spatial-data">
<h2>More Complex Implementation: Spatial Data<a class="headerlink" href="#more-complex-implementation-spatial-data" title="Permalink to this headline">#</a></h2>
<p>As discussed in class, precipitation takes time to travel from where it fell to the basin outlet.  Next we will estimate the runoff response in a real catchment, just upstream from the parking lot example in the FitzSimmons Creek basin.</p>
<section id="step-1-instantiate-a-grid-from-a-dem-raster">
<h3>Step 1: Instantiate a grid from a DEM raster<a class="headerlink" href="#step-1-instantiate-a-grid-from-a-dem-raster" title="Permalink to this headline">#</a></h3>
<p>Some sample data is already included, but for extra data, see the <a class="reference external" href="https://www.hydrosheds.org/">USGS hydrosheds project</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># grid = Grid.from_raster(&#39;data/n45w125_con_grid/n45w125_con/n45w125_con&#39;, data_name=&#39;dem&#39;)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">from_ascii</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;../../data/notebook_5_data/n49w1235_con_grid.asc&#39;</span><span class="p">,</span> 
                       <span class="n">data_name</span><span class="o">=</span><span class="s1">&#39;dem&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reset the nodata from -32768 so it doesn&#39;t throw off the </span>
<span class="c1"># DEM plot</span>
<span class="n">grid</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># store the extents of the map</span>
<span class="n">map_extents</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">extent</span>
<span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">map_extents</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-dem">
<h3>Plot the DEM<a class="headerlink" href="#plot-the-dem" title="Permalink to this headline">#</a></h3>
<p><strong>NOTE:</strong> The cell below may take up to 30 seconds to load.  Please be patient, it is thinking really hard.</p>
<p>The code below will plot the Digital Elevation Model (DEM).</p>
<p>Do you recognize any features of the terrain?  Can you locate where it is?</p>
<p>Hover over the map (or touch if using a touchscreen) to see the coordinates in decimal degree units.</p>
<p>What does the <a class="reference external" href="http://wiki-1-1930356585.us-east-1.elb.amazonaws.com/wiki/index.php/Decimal_degrees">precision of the coordinates represent</a>?</p>
<ul class="simple">
<li><p>i.e. what does 5 decimal places in decimal degrees equate to in kilometers?</p></li>
</ul>
<p>You can interact with the plot by using the tools on the left (in vertical order from top to bottom):</p>
<ul class="simple">
<li><p><strong>pan:</strong> move around the map</p></li>
<li><p><strong>box zoom:</strong> draw a square to zoom in on</p></li>
<li><p><strong>wheel zoom:</strong> use the mousewheel (or pinch gesture on a touchscreen) to zoom in</p></li>
<li><p><strong>box zoom:</strong> draw a square to zoom in on</p></li>
<li><p><strong>tap</strong>: not yet implemented (but you can see the coordinates)</p></li>
<li><p><strong>refresh</strong>: reset the map</p></li>
<li><p><strong>hover</strong>: see the coordinates when hovering over the map with a mouse or pointer</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set bokeh plot tools</span>
<span class="n">tools</span> <span class="o">=</span> <span class="s2">&quot;pan,wheel_zoom,box_zoom,reset,tap&quot;</span>

<span class="c1"># show the precision of the decimal coordinates</span>
<span class="c1"># in the plot to 5 decimal places</span>
<span class="n">TOOLTIPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;(x,y)&quot;</span><span class="p">,</span> <span class="s2">&quot;($x</span><span class="si">{1.11111}</span><span class="s2">, $y</span><span class="si">{1.11111}</span><span class="s2">)&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># create a figure, setting the x and y ranges to the appropriate data bounds</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;DEM of the Lower Mainland of BC.  Hover to get coordintes.&quot;</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">400</span><span class="p">),</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">map_extents</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">y_range</span> <span class="o">=</span> <span class="n">map_extents</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> 
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tooltips</span><span class="o">=</span><span class="n">TOOLTIPS</span><span class="p">)</span>

<span class="c1"># map elevation to a colour spectrum</span>
<span class="n">color_mapper</span> <span class="o">=</span> <span class="n">LinearColorMapper</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Magma256&quot;</span><span class="p">,</span> <span class="n">low</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2400</span><span class="p">)</span>

<span class="c1"># np.flipud flips the image data on a vertical axis</span>
<span class="n">adjusted_img</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">dem</span><span class="p">)]</span>  

<span class="n">p1</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">adjusted_img</span><span class="p">,</span>   
         <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">min_x</span><span class="p">],</span>               <span class="c1"># lower left x coord</span>
         <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">min_y</span><span class="p">],</span>               <span class="c1"># lower left y coord</span>
         <span class="n">dw</span><span class="o">=</span><span class="p">[</span><span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span><span class="p">],</span>        <span class="c1"># *data space* width of image</span>
         <span class="n">dh</span><span class="o">=</span><span class="p">[</span><span class="n">max_y</span><span class="o">-</span><span class="n">min_y</span><span class="p">],</span>        <span class="c1"># *data space* height of image</span>
         <span class="n">color_mapper</span><span class="o">=</span><span class="n">color_mapper</span>
<span class="p">)</span>

<span class="n">color_bar</span> <span class="o">=</span> <span class="n">ColorBar</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">=</span><span class="n">color_mapper</span><span class="p">,</span> <span class="c1">#ticker=Ticker(),</span>
                     <span class="n">label_standoff</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">border_line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

<span class="n">p1</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">color_bar</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span>


<span class="n">show</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

<span class="c1"># -123.15512, 49.41293</span>
<span class="c1">#-123.14657, 49.41080</span>
<span class="o">-</span><span class="mf">123.14350</span><span class="p">,</span> <span class="mf">49.40251</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="resolve-flats-in-dem">
<h3>Resolve flats in DEM<a class="headerlink" href="#resolve-flats-in-dem" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">resolve_flats</span><span class="p">(</span><span class="s1">&#39;dem&#39;</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;inflated_dem&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="specify-flow-direction-values">
<h3>Specify flow direction values<a class="headerlink" href="#specify-flow-direction-values" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#         N    NE    E    SE    S    SW    W    NW</span>
<span class="n">dirmap</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>    <span class="mi">16</span><span class="p">,</span>  <span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">flowdir</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;inflated_dem&#39;</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="n">dirmap</span><span class="o">=</span><span class="n">dirmap</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">boundaries</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dirmap</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span> <span class="n">boundaries</span><span class="p">,</span>
             <span class="n">values</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dirmap</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Flow direction grid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1"># plt.savefig(&#39;data/img/flow_direction.png&#39;, bbox_inches=&#39;tight&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view the values of the raster as an array</span>
<span class="n">grid</span><span class="o">.</span><span class="n">dir</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the size of the raster</span>
<span class="n">grid</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="delineate-a-catchment">
<h3>Delineate a Catchment<a class="headerlink" href="#delineate-a-catchment" title="Permalink to this headline">#</a></h3>
<p>Note that once you’ve executed the code in the cells below,
if you change the Point of Concentration (POC), you’ll
need to go back to Step 1 and execute the code from there again.</p>
<p>This needs to be done to re-initialize the extents of the data
that are loaded into memory.  The intermediary steps trim the extent
of the DEM and you will get an error message saying:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ValueError:</span> <span class="pre">Pour</span> <span class="pre">point</span> <span class="pre">(-123.94307,</span> <span class="pre">49.40783)</span> <span class="pre">is</span> <span class="pre">out</span> <span class="pre">of</span> <span class="pre">bounds</span> <span class="pre">for</span> <span class="pre">dataset</span> <span class="pre">with</span> <span class="pre">bbox</span> <span class="pre">(-123.195000000122,</span> <span class="pre">49.39999999984,</span> <span class="pre">-123.15333333347199,</span> <span class="pre">49.421666666498).</span></code></p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the Point of Concentration (POC) / Catchment Outlet (a.k.a. pour point) </span>
<span class="c1"># This location is a tributary of the Capilano River, just above the reservoir above</span>
<span class="c1"># Cleveland Dam.</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">123.14657</span><span class="p">,</span> <span class="mf">49.41080</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">123.14350</span><span class="p">,</span> <span class="mf">49.40251</span>

<span class="c1"># And just for good measure, here&#39;s the little tributary in the south-west corner.</span>
<span class="c1"># Note the instructions above about reloading the original data to re-initialize</span>
<span class="c1"># the DEM</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">123.15512</span><span class="p">,</span> <span class="mf">49.41293</span>

<span class="c1"># Delineate the catchment</span>
<span class="n">grid</span><span class="o">.</span><span class="n">clip_to</span><span class="p">(</span><span class="s1">&#39;dem&#39;</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">catchment</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">dirmap</span><span class="o">=</span><span class="n">dirmap</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span>
               <span class="n">recursionlimit</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span> <span class="n">xytype</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">nodata_out</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clip the bounding box to the catchment we&#39;ve chosen</span>
<span class="n">grid</span><span class="o">.</span><span class="n">clip_to</span><span class="p">(</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a view of the catchment</span>
<span class="n">catch</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the shape to see if we&#39;ve estimated close enough to the </span>
<span class="c1"># actual river to delineate the catchment successfully</span>
<span class="nb">print</span><span class="p">(</span><span class="n">catch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># if we get dimensions of &lt; 10, we&#39;ve missed and instead pointed at some </span>
<span class="c1"># little hillslope</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>
<span class="n">ext_1</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">extent</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the catchment</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">catch</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dirmap</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Flow Direction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Delineated Catchment&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;data/img/catchment.png&#39;, bbox_inches=&#39;tight&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-flow-accumulation">
<h3>Get flow accumulation<a class="headerlink" href="#get-flow-accumulation" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">accumulation</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">dirmap</span><span class="o">=</span><span class="n">dirmap</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;acc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">acc_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">acc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">acc_img</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cubehelix&#39;</span><span class="p">,</span>
               <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">acc</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upstream Cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Flow Accumulation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;data/img/flow_accumulation.png&#39;, bbox_inches=&#39;tight&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-distances-to-upstream-cells">
<h3>Calculate distances to upstream cells<a class="headerlink" href="#calculate-distances-to-upstream-cells" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">flow_distance</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">dirmap</span><span class="o">=</span><span class="n">dirmap</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span>
                   <span class="n">xytype</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">nodata_out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cubehelix_r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Distance to outlet (cells)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Flow Distance&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;data/img/flow_distance.png&#39;, bbox_inches=&#39;tight&#39;),</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area_threshold</span><span class="o">=</span><span class="mi">20</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">streamnetwork_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">acc_img</span><span class="o">&gt;</span><span class="n">area_threshold</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">acc_img</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># print([[&#39;nan&#39; if np.isnan(i) else cmap[i] for i in j] for j in streamnetwork_img])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;Catchment&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Outside Catchment&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span> <span class="s1">&#39;Stream Network&#39;</span><span class="p">}</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.247</span><span class="p">,</span> <span class="mf">0.552</span><span class="p">,</span> <span class="mf">0.266</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> 
        <span class="mi">100</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.074</span><span class="p">,</span> <span class="mf">0.231</span><span class="p">,</span> <span class="mf">0.764</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
       <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.760</span><span class="p">,</span> <span class="mf">0.760</span><span class="p">,</span> <span class="mf">0.760</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]}</span>

<span class="n">arrayShow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cmap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">else</span> <span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">streamnetwork_img</span><span class="p">])</span>    
<span class="c1">## create patches as legend</span>

<span class="n">patches</span> <span class="o">=</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">]</span>

<span class="c1"># streamnetwork_img = np.where(grid.mask, &gt; 100, 10 , 1)</span>
<span class="c1"># im = ax.imshow(streamnetwork_img, extent=grid.extent, zorder=2,</span>
<span class="c1">#                 cmap=&#39;cubehelix&#39;)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arrayShow</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
<span class="c1"># plt.colorbar(im, ax=ax, label=&#39;Upstream Cells&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stream network&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;data/img/stream_network.png&#39;, bbox_inches=&#39;tight&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-weighted-travel-distance">
<h3>Calculate weighted travel distance<a class="headerlink" href="#calculate-weighted-travel-distance" title="Permalink to this headline">#</a></h3>
<p>Assign a travel time to each cell based on the assumption that water travels at one speed (slower) until it reaches a stream network, at which point its speed increases dramatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">clip_to</span><span class="p">(</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;acc&#39;</span><span class="p">)</span>

<span class="c1"># calculate weights.</span>
<span class="c1"># assume the threshold is 100 accumulation cells </span>
<span class="c1"># (of roughly 500mx500m) results in stream</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">acc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">weighted_dist</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">flow_distance</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                   <span class="n">xytype</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">weighted_dist</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cubehelix_r&#39;</span><span class="p">)</span>
<span class="c1"># plt.legend(handles=patches, loc=1, borderaxespad=0.)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upstream Cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stream network&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="develop-rainfall-runoff-model">
<h2>Develop Rainfall-Runoff Model<a class="headerlink" href="#develop-rainfall-runoff-model" title="Permalink to this headline">#</a></h2>
<p>Now that we have weighted flow distances for each cell in the delineated catchment, we can apply precipitation to each ‘cell’ in order to reconstruct a flow hydrograph.</p>
<p>First, we must figure out the cell dimensions.  From the <a class="reference external" href="https://hydrosheds.cr.usgs.gov/datadownload.php">USGS Hydrosheds information</a>, we know the resolution is 15 (degree) seconds.  Because the earth is not a perfect sphere, <a class="reference external" href="https://epsg.io/">coordinate projection systems</a> (CRS) are used to approximate the surface of the earth so that spatial distances can be more accurately represented.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cells can be grouped by their weighted distance to the outlet to simplify </span>
<span class="c1"># the process of calculating the contribution of each cell to flow at the outlet</span>

<span class="n">dist_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">dist_df</span><span class="p">[</span><span class="s1">&#39;weighted_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_dist</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="c1"># trim the distance dataframe to include only the cells in the catchment,</span>
<span class="c1"># and round the travel time to the nearest one (hour)</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_df</span><span class="p">[</span><span class="n">dist_df</span><span class="p">[</span><span class="s1">&#39;weighted_dist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_date</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># create an hourly dataframe based on the sample precipitation event</span>
<span class="c1"># then resample the values to evenly distribute the total daily </span>
<span class="c1"># precipitation to hourly precipitation</span>
<span class="n">resampled_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pad</span><span class="p">()</span> <span class="o">/</span> <span class="mi">24</span>
</pre></div>
</div>
</div>
</div>
<p>Note that our ‘weighted distance’ has just provided a relative difference between the flow accumulation cells and non-flow-accumulation cells.  We still must convert these values to some time-dependent form.</p>
<p>For this exercise, we will assume the average velocity of water is 1 m/s value for the flow accumulation cells, and 0.1 m/s for the other cells.  Therefore precipitation will take on average 300s (0.0833 h) and 3000s (0.833 h) to travel to the outlet for flow-accumulation and non-flow-accumulation cells, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the number of cells of each distance</span>
<span class="n">grouped_dists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dist_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;weighted_dist&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
<span class="n">grouped_dists</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;num_cells&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create unit hydrographs for each timestep</span>
<span class="n">runoff_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resampled_df</span><span class="p">)))</span>
<span class="n">runoff_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">]</span>
<span class="n">runoff_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">resampled_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">runoff_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">max_distance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">grouped_dists</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">extended_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">extended_df</span><span class="p">[</span><span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_distance</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">extended_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">max_distance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span>

<span class="c1"># append the extra time to the runoff dataframe</span>
<span class="n">runoff_df</span> <span class="o">=</span> <span class="n">runoff_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extended_df</span><span class="p">)</span>
<span class="n">runoff_df</span><span class="p">[</span><span class="s1">&#39;Runoff (cms)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p><strong>NOTE</strong>: if you re-run the cell below, you need to run the cell above as well, or the runoff dataframe will not reset and the values will keep increasing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_size</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># assume each pixel represents 300m x 300m </span>
<span class="n">runoff_coefficient</span> <span class="o">=</span> <span class="mf">0.3</span>


<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resampled_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">this_hyd</span> <span class="o">=</span> <span class="n">resampled_df</span><span class="p">[[</span><span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">weight_dist</span><span class="p">,</span> <span class="n">num_cells</span> <span class="ow">in</span> <span class="n">grouped_dists</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">outlet_time</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">weight_dist</span><span class="p">)</span>
            <span class="n">precip</span> <span class="o">=</span> <span class="n">num_cells</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">]</span>
            <span class="n">runoff_vol</span> <span class="o">=</span> <span class="n">precip</span> <span class="o">*</span> <span class="n">runoff_coefficient</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">cell_size</span><span class="o">**</span><span class="mi">2</span> 
            <span class="n">runoff_rate</span> <span class="o">=</span> <span class="n">runoff_vol</span>  <span class="o">/</span> <span class="mi">3600</span>  <span class="c1"># convert to m^3/s from m^3/h</span>
            <span class="n">runoff_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlet_time</span><span class="p">,</span> <span class="s1">&#39;Runoff (cms)&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">runoff_rate</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">break</span>
<span class="c1">#             print(err)</span>
<span class="c1">#             print(ind, row)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="n">sample_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2014-12-01&#39;</span><span class="p">)</span>
<span class="n">sample_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2014-12-15&#39;</span><span class="p">)</span>

<span class="n">sample_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">sample_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">sample_end</span><span class="p">)][[</span><span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Snow (cm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Rain (mm)&#39;</span><span class="p">]]</span>

<span class="c1"># print(sample_df.head())</span>
<span class="c1"># plot the original daily precip</span>
<span class="c1"># ax.plot(sample_df.index, sample_df[&#39;Total Precip (mm)&#39;], label=&quot;Total Precip [mm]&quot;)</span>
<span class="c1"># ax.plot(sample_df.index, sample_df[&#39;Total Snow (cm)&#39;], label=&quot;Total Snow [cm]&quot;)</span>
<span class="c1"># ax.plot(sample_df.index, sample_df[&#39;Total Rain (mm)&#39;], label=&quot;Total Rain [mm]&quot;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">runoff_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">runoff_df</span><span class="p">[</span><span class="s1">&#39;Runoff (cms)&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Runoff&quot;</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Runoff [cms]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Example Rainfall-Runoff Model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sample_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sample_df</span><span class="p">[</span><span class="s1">&#39;Total Rain (mm)&#39;</span><span class="p">],</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total Rain&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Precipitation [mm]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="determine-the-peak-unit-runoff">
<h3>Determine the Peak Unit Runoff<a class="headerlink" href="#determine-the-peak-unit-runoff" title="Permalink to this headline">#</a></h3>
<p>First, estimate the drainage area.  Then, find the peak hourly flow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DA</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">grouped_dists</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">max_UR</span> <span class="o">=</span> <span class="n">runoff_df</span><span class="p">[</span><span class="s1">&#39;Runoff (cms)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">DA</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The drainage area is </span><span class="si">{}</span><span class="s1"> km^2 and the peak Unit Runoff is </span><span class="si">{}</span><span class="s1"> L/s/km^2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_UR</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Discuss the limitations of the approach.  Where do uncertainties exist?</p>
<ul class="simple">
<li><p>assumed precipitation is constant across days</p></li>
<li><p>assumed constant runoff coefficient</p></li>
<li><p>assumed two weights for travel time, constant across time</p></li>
</ul>
</section>
</section>
<section id="question-for-reflection">
<h2>Question for Reflection<a class="headerlink" href="#question-for-reflection" title="Permalink to this headline">#</a></h2>
<p>For the first part where we estimated the water level at the parking lot outlet based on an assumption that there was zero infiltration, assuming all else is equal, how could we reduce the maximum water level to 5 cm?</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/Notebook_4"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../Notebook_3/Notebook_3.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Notebook 3: Regional Information Transfer</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../Notebook_5/Notebook_5.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Notebook 5: Extreme Values, Uncertainty, and Risk</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Dan Kovacek<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>